<!doctype html>
    <html lang="en">
        <head>
            <style>
            form label {
              display: inline-block;
              width: 200px;
            }
            #cover  {
                float: right;
                margin: 0 0 0 5px;
            }
            </style>
            <meta charset="utf-8">
        </head>
        <body>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.js"></script>
            <script src="https://unpkg.com/freezeframe/dist/freezeframe.min.js"></script>
            <script src="../_static/audio-mixer/renderjson.js"></script>
            <figure>
                <img src="../_static/audio-mixer/evans/cover.jpg" alt="" width="200px" height="200px" id="cover"/>
            </figure>
            <div>
                <label><b>Select a track üéµ:</b></label>
                <select name="select" id="select" onchange="getTrack()">
                    <option value="evans">Bill Evans: 'Come Rain or Come Shine' (1965)</option>
                    <option value="mance">Junior Mance: 'For Dancers Only' (1962)</option>
                    <option value="jamal">Ahmad Jamal: 'Tater Pie' (1992)</option>
                </select>
            </div>
            <p></p>
            <div>
                <label><b>Audio controls üéõ:</b></label>
                <button id="play">Play ‚ñ∂</button>
                <button id="pause">Pause ‚è∏</button>
                <button id="stop">Stop ‚èπ</button>
                <button id="metronome">Metronome OFF</button>
                <img class="freezeframe" src="../_static/audio-mixer/recordspin.gif" alt="Spinning record" id="recordspin" style="width:35px;height:35px;background:none;border:none" >
            </div>
            <p></p>
            <form>
                <p><label><b>Volume faders üéö:</b></label></p>
                <p><label>Piano üéπ</label><input id="pianovol" type="range" min="0" max="1" value="1" step="0.1" onchange="updateVol(this.value, piano)" oninput="updateVol(this.value, piano)"/></p>
                <p><label>Bass üéª</label><input id="bassvol" type="range" min="0" max="1" value="1" step="0.1" onchange="updateVol(this.value, bass)" oninput="updateVol(this.value, bass)"/></p>
                <p><label>Drums ü•Å</label><input id="drumsvol" type="range" min="0" max="1" value="1" step="0.1" onchange="updateVol(this.value, drums)" oninput="updateVol(this.value, drums)"/></p>
            </form>
            <p><label><b>Track metadata:</b></label></p>
            <div id="jsoncontainer"></div>
            <script>
                renderjson.set_show_to_level(1);
                var ff = new Freezeframe(document.getElementById("recordspin"), {responsive: false, trigger: false});
                ff.stop();

                const play = document.getElementById("play");
                play.addEventListener("click", playFunc);
                const pause = document.getElementById("pause");
                pause.addEventListener("click", pauseFunc);
                const stop = document.getElementById("stop");
                stop.addEventListener("click", stopFunc);
                const metronome = document.getElementById("metronome");
                disableButtons()

                metronome.style.backgroundColor = '#FF0000';
                metronome.addEventListener("click", metronomeFunc);
                var metronomeVol = 0;

                var bass;
                bassLoaded = false;
                var piano;
                pianoLoaded = false;
                var drums;
                drumsLoaded = false;
                var beats;
                beatsLoaded = false;
                getTrack()

                function disableButtons() {
                    play.disabled = true;
                    pause.disabled = true;
                    stop.disabled = true;
                    metronome.disabled = true;
                }

                function enableButtons() {
                    play.disabled = false;
                    pause.disabled = false;
                    stop.disabled = false;
                    metronome.disabled = false;
                }

                function addJSON(trackFname) {
                    let request = new XMLHttpRequest();
                    request.open("GET", `${trackFname}/metadata.json`, false);
                    request.send(null)
                    let js = JSON.parse(request.responseText);
                    let cont = document.getElementById("jsoncontainer")
                    cont.textContent = ''
                    cont.appendChild(renderjson(js));
                }

                function getStem(trackFname, instr, isLoaded) {
                    let stemFname = `${trackFname}/${instr}.wav`;
                    let stemSlide = document.getElementById(`${instr}vol`);
                    let stemVol = stemSlide.value;
                    return new Howl ({
                        src: [stemFname],
                        volume: stemVol,
                        loop:  false,
                        preload: true,
                        onend: stopFunc,
                        onload: function logger() {
                            isLoaded = true;
                        }
                    })
                }

                function getTrack() {
                    disableButtons()
                    let select = document.getElementById("select");
                    let track = select.value;
                    let trackFname = `../_static/audio-mixer/${track}`;
                    addJSON(trackFname)
                    var img = document.getElementById("cover");
                    img.src=`${trackFname}/cover.jpg`;
                    if (bass instanceof Howl) {
                        stopFunc()
                    }
                    bass = getStem(trackFname, "bass", bassLoaded);
                    piano = getStem(trackFname, "piano", pianoLoaded);
                    drums = getStem(trackFname, "drums", drumsLoaded);
                    beats = new Howl ({
                        src: [`${trackFname}/beats.wav`],
                        volume: metronomeVol,
                        loop:  false,
                        preload: true,
                        onload: function logger() {
                            beatsLoaded = true;
                        }
                    })
                    checkAllLoaded()
                }

                function checkLoaded(howl_) {
                    return (howl_.state() === "loaded")
                }

                function checkAllLoaded() {
                    let allLoaded = [checkLoaded(piano), checkLoaded(bass), checkLoaded(drums), checkLoaded(beats)]
                    console.log(allLoaded)
                    if (!allLoaded.every(Boolean)) {
                       window.setTimeout(checkAllLoaded, 100);
                    } else {
                        enableButtons()
                    }
                }

                function playFunc() {
                    ff.start()
                    play.style.backgroundColor = "#008000";
                    pause.style.backgroundColor = '';
                    bass.play();
                    drums.play();
                    piano.play();
                    beats.play();
                }

                function pauseFunc() {
                    ff.stop()
                    play.style.backgroundColor = '';
                    pause.style.backgroundColor = '#FF0000';
                    bass.pause();
                    drums.pause();
                    piano.pause();
                    beats.pause();
                }

                function stopFunc() {
                    ff.stop()
                    play.style.backgroundColor = '';
                    pause.style.backgroundColor = '';
                    bass.stop();
                    drums.stop();
                    piano.stop();
                    beats.stop();
                }

                function metronomeFunc() {
                    if (metronomeVol === 1) {
                        metronomeVol = 0
                        beats.volume(metronomeVol);
                        metronome.style.backgroundColor = '#FF0000';
                        metronome.innerText = 'Metronome OFF';
                    }
                    else {
                        metronomeVol = 1
                        beats.volume(metronomeVol);
                        metronome.style.backgroundColor = "#008000";
                        metronome.innerText = 'Metronome ON';
                    }
                }

                function updateVol(newValue, howl) {
                    howl.volume(newValue);
                }
            </script>
        </body>
    </html>